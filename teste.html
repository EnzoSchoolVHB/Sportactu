<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Teste</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <!-- ICONS CDN FONTAWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body onload="fetchNextRace(); fetchAndDisplayResults(); fetchRaceList();" class="light-mode">

<!-- Intégrer le nouveau bouton de mode sombre -->
<div class="btn" onclick="toggleDarkMode()">
    <div class="btn__indicator">
        <div class="btn__icon-container">
            <i class="btn__icon fa-solid"></i>
        </div>
    </div>
</div>
<script src="js/main.js"></script>

<!-- Haut de Page -->
<header>
    <img src="img/f1.png" width="70">
    <p>
        <!-- Page de test (texte) -->
    </p>
</header>

<!-- Tableau pour le minuteur -->
<div id="countdownTable">
    <h2 id="grandPrixLocation">Grand Prix</h2>
    <p>Début de la course :</p>
    <table>
        <tr>
            <th>DAYS</th>
            <th>HRS</th>
            <th>MINS</th>
        </tr>
        <tr>
            <td id="days">00</td>
            <td id="hours">00</td>
            <td id="mins">00</td>
        </tr>
    </table>
    <div id="startDateTime"></div>
</div>

<!-- Menu déroulant pour les courses -->
<select id="raceSelector" onchange="fetchAndDisplayResults(this.value);"></select>

<!-- JavaScript pour le minuteur et les résultats -->
<script>
    let countdownInterval;

    function startCountdown(grandPrixDate, grandPrixLocation) {
        const targetDate = new Date(grandPrixDate);  // Date et heure de la course
        const targetTimeMillis = targetDate.getTime();

        // Vérifier que la date est valide
        if (isNaN(targetTimeMillis)) {
            console.error("La date du Grand Prix n'est pas valide :", grandPrixDate);
            document.getElementById("grandPrixLocation").textContent = "Date de course invalide.";
            return;
        }

        if (countdownInterval) {
            clearInterval(countdownInterval);  // Si un chrono est déjà en cours, on le supprime
        }

        countdownInterval = setInterval(() => {
            const currentTime = new Date().getTime();
            const remainingTimeMillis = targetTimeMillis - currentTime;

            if (remainingTimeMillis <= 0) {
                clearInterval(countdownInterval);
                document.getElementById("grandPrixLocation").textContent = "La course a commencé !";
            } else {
                const days = Math.floor(remainingTimeMillis / (1000 * 60 * 60 * 24));
                const hours = Math.floor((remainingTimeMillis % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((remainingTimeMillis % (1000 * 60 * 60)) / (1000 * 60));

                // Mettre à jour l'interface utilisateur
                document.getElementById("days").textContent = days;
                document.getElementById("hours").textContent = hours;
                document.getElementById("mins").textContent = minutes;
                document.getElementById("grandPrixLocation").textContent = `Prochain Grand Prix : ${grandPrixLocation}`;
                document.getElementById("startDateTime").textContent = `Début à : ${targetDate.toLocaleString()}`;
            }
        }, 1000);
    }

    function fetchNextRace() {
        fetch('https://ergast.com/api/f1/current.json')
            .then(response => response.json())
            .then(data => {
                const races = data.MRData.RaceTable.Races;
                const now = new Date();
                let nextRaceFound = false;

                for (let race of races) {
                    const raceDate = new Date(`${race.date}T${race.time}Z`);  // Ajout du "Z" pour UTC

                    // Vérifier si la course est valide
                    if (isNaN(raceDate.getTime())) {
                        console.error("La date de la course n'est pas valide :", race);
                        continue;  // Passer à la prochaine course si la date n'est pas valide
                    }

                    if (raceDate > now) {
                        startCountdown(raceDate, race.raceName);
                        nextRaceFound = true;
                        break;  // Arrêter la boucle dès qu'une prochaine course est trouvée
                    }
                }

                if (!nextRaceFound) {
                    document.getElementById("grandPrixLocation").textContent = "Aucune course future disponible.";
                }
            })
            .catch(error => console.error('Erreur lors de la récupération des informations de la course :', error));
    }

    function fetchRaceList() {
        fetch('https://ergast.com/api/f1/current.json')
            .then(response => response.json())
            .then(data => {
                const raceSelector = document.getElementById('raceSelector');
                raceSelector.innerHTML = "";

                data.MRData.RaceTable.Races.forEach(race => {
                    const option = document.createElement('option');
                    option.value = race.round;
                    option.text = race.raceName;
                    raceSelector.add(option);
                });
            })
            .catch(error => console.error('Erreur lors de la récupération de la liste des courses :', error));
    }
</script>

<!-- Widgets Twitter côte à côte -->
<div class="twitter-widgets-container">
    <section class="twitter-widget" id="twitter-widget-left">
        <a class="twitter-timeline" data-width="700" data-height="900" href="https://twitter.com/Secteur_F1">Tweets by Secteur_F1</a>
    </section>

    <!-- Clearfix pour éviter les problèmes de mise en page -->
    <div class="clearfix"></div>

    <!-- Pied de Page -->
    <footer>
        <p>
            2022-2023 - All Right Reserved
        </p>
    </footer>
</body>
</html>
